name: Kronos CI
permissions:
  contents: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc make gperf

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # macOS comes with Xcode command line tools
          xcode-select --install 2>/dev/null || true

      - name: Build unit tests
        run: make clean && make test-unit

      - name: Run unit tests
        run: ./tests/unit/kronos_unit_tests

  integration-tests:
    name: Integration Tests
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc make gperf

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # macOS comes with Xcode command line tools
          xcode-select --install 2>/dev/null || true

      - name: Build Kronos
        run: make clean && make

      - name: Verify binary exists
        run: |
          test -f ./kronos
          echo "✓ Kronos binary created"

      - name: Run passing integration tests
        run: |
          for test_file in tests/integration/pass/*.kr; do
            if [ -f "$test_file" ]; then
              ./kronos "$test_file" || exit 1
            fi
          done
          echo "✓ All passing integration tests succeeded"

      - name: Run error integration tests
        run: |
          for test_file in tests/integration/fail/*.kr; do
            if [ -f "$test_file" ]; then
              ./kronos "$test_file" && exit 1 || true
            fi
          done
          echo "✓ All error integration tests correctly failed"

      - name: Test REPL mode
        run: |
          echo "set x to 42" | ./kronos
          echo "✓ REPL mode works"

      - name: Test example files
        run: |
          ./kronos examples/hello.kr
          ./kronos examples/variables.kr
          ./kronos examples/functions.kr
          echo "✓ Example files run successfully"

  lint-and-format:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for trailing whitespace
        run: |
          ! git grep -I --line-number '[[:blank:]]$' -- '*.c' '*.h' '*.kr' || {
            echo "Error: Found trailing whitespace"
            exit 1
          }
          echo "✓ No trailing whitespace"

      - name: Check file encodings
        run: |
          file_list=$(find . -name "*.c" -o -name "*.h" -o -name "*.kr")
          for f in $file_list; do
            if ! file "$f" | grep -q "ASCII\|UTF-8"; then
              echo "Error: $f has incorrect encoding"
              exit 1
            fi
          done
          echo "✓ All files have correct encoding"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check documentation files exist
        run: |
          # Core documentation files (detailed docs now at kronos.nedanwr.dev)
          docs=(
            "README.md"
            "LICENSE"
            "CHANGELOG.md"
            "ROADMAP.md"
            "docs/PROJECT.md"
            "tests/README.md"
            "examples/README.md"
          )
          for doc in "${docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "Error: Missing documentation file: $doc"
              exit 1
            fi
          done
          echo "✓ All required documentation files exist"

      - name: Check for broken links in README
        run: |
          # Simple check for common markdown link issues
          grep -n '\[.*\](' README.md || true
          echo "✓ README links checked"
